---
title: "Process_IDAWEB_data"
author: 'Noémie Wellinger'
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
source("../R/load_packages.R")
load_packages(c("dplyr", "ggplot2", "climaemet"))
```
Precipitation
```{r}
# Load the data
folder <- "../data/IDAWEB/Precipitation/"
# read the text file that ends with "data.txt"
file_path <- list.files(folder, pattern = "data.txt$", full.names = TRUE)
# read as as text file
lines <- readLines(file_path)

# Remove empty lines
lines <- lines[lines != ""]

# Find indices where headers appear
header_indices <- grep("^stn\\s+time", lines)

# Read the first table
table1 <- read.table(text = paste(lines[(header_indices[1] + 1):(header_indices[2] - 1)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "rre150z0"),
                     stringsAsFactors = FALSE)
# Convert `time` to a proper datetime format (if needed)
table1$time <- as.POSIXct(as.character(table1$time), format="%Y%m%d%H%M")

# Read the second table
table2 <- read.table(text = paste(lines[(header_indices[2] + 1):length(lines)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "rre150h0", "rre024i0", "rre072i0"),
                     stringsAsFactors = FALSE)
# Convert `time` to a proper datetime format (if needed)
table2$time <- as.POSIXct(as.character(table2$time), format="%Y%m%d%H")

# Merge both tables on "stn" and "time"
final_df <- full_join(table1, table2, by = c("stn", "time"))

# rename the columns
# Parameter Einheit                              Beschreibung
# rre150h0  mm                                   Niederschlag; Stundensumme
# rre024i0  mm                                   Niederschlagssumme ?ber 24 Stunden
# rre072i0  mm                                   Niederschlagssumme ?ber 72 Stunden
# rre150z0  mm                                   Niederschlag; Zehnminutensumme 
IDAWEB_final_df <- final_df |>
  rename(precip_last1h = rre150h0, 
         precip_last24h = rre024i0,
         precip_last72h = rre072i0,
         precip_10min = rre150z0)

# View the final data frame
print(IDAWEB_final_df)
```
Radiation
```{r}
folder <- "../data/IDAWEB/Radiation_Humidity_Pressure/"
file_path <- list.files(folder, pattern = "data.txt$", full.names = TRUE)
lines <- readLines(file_path)
lines <- lines[lines != ""]
header_indices <- grep("^stn\\s+time", lines)


table1 <- read.table(text = paste(lines[(header_indices[1] + 1):(header_indices[2] - 1)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "gre000z0", "prestas0", "ure200s0"),
                     stringsAsFactors = FALSE)
table1$time <- as.POSIXct(as.character(table1$time), format="%Y%m%d%H%M")


table2 <- read.table(text = paste(lines[(header_indices[2] + 1):length(lines)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "gre000h0", "prestah0", "ure200h0"),
                     stringsAsFactors = FALSE)
table2$time <- as.POSIXct(as.character(table2$time), format="%Y%m%d%H")


final_df <- full_join(table1, table2, by = c("stn", "time"))
IDAWEB_final_df <- full_join(IDAWEB_final_df, final_df, by = c("stn", "time"))

# Parameter Einheit                              Beschreibung
# gre000h0  W/m²                                 Globalstrahlung; Stundenmittel
# prestah0  hPa                                  Luftdruck auf Barometerhöhe (QFE); Stundenmittel
# ure200h0  %                                    Relative Luftfeuchtigkeit 2 m über Boden; Stundenmittel
# gre000z0  W/m²                                 Globalstrahlung; Zehnminutenmittel
# prestas0  hPa                                  Luftdruck auf Barometerhöhe (QFE); Momentanwert
# ure200s0  %                                    Relative Luftfeuchtigkeit 2 m über Boden; Momentanwert

IDAWEB_final_df <- IDAWEB_final_df |>
  rename(glob_rad_h = gre000h0,
         glob_rad_10min = gre000z0,
         airpress_h = prestah0,
         airpress_10min = prestas0,
         RH_2m_h = ure200h0,
         RH_2m_10min = ure200s0)

print(IDAWEB_final_df)
```

Temperature
```{r}
folder <- "../data/IDAWEB/Temperature/"
file_path <- list.files(folder, pattern = "data.txt$", full.names = TRUE)
lines <- readLines(file_path)
lines <- lines[lines != ""]
header_indices <- grep("^stn\\s+time", lines)


table1 <- read.table(text = paste(lines[(header_indices[1] + 1):(header_indices[2] - 1)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "tre200s0","tpo200s0"),
                     stringsAsFactors = FALSE)
table1$time <- as.POSIXct(as.character(table1$time), format="%Y%m%d%H%M")


table2 <- read.table(text = paste(lines[(header_indices[2] + 1):length(lines)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "tre200h0"),
                     stringsAsFactors = FALSE)
table2$time <- as.POSIXct(as.character(table2$time), format="%Y%m%d%H")


final_df <- full_join(table1, table2, by = c("stn", "time"))
IDAWEB_final_df <- full_join(IDAWEB_final_df, final_df, by = c("stn", "time"))

# Parameter Einheit                              Beschreibung
# tre200s0  °C                                   Lufttemperatur 2 m über Boden; Momentanwert
# tpo200s0  °C                                   Potentielle Temperatur 2 m über Boden; Momentanwert
# tre200h0  °C                                   Lufttemperatur 2 m über Boden; Stundenmittel

IDAWEB_final_df <- IDAWEB_final_df |>
  rename(temp_air_2m_10min = tre200s0,
         temp_air_2m_h = tre200h0,
         temp_pot_2m_10m = tpo200s0)

print(IDAWEB_final_df)
```

Wind
```{r}
folder <- "../data/IDAWEB/Wind/"
file_path <- list.files(folder, pattern = "data.txt$", full.names = TRUE)
lines <- readLines(file_path)
lines <- lines[lines != ""]
header_indices <- grep("^stn\\s+time", lines)


table1 <- read.table(text = paste(lines[(header_indices[1] + 1):(header_indices[2] - 1)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "fkl010z0", "fu3010z0", "dkl010z0"),
                     stringsAsFactors = FALSE)
table1$time <- as.POSIXct(as.character(table1$time), format="%Y%m%d%H%M")


table2 <- read.table(text = paste(lines[(header_indices[2] + 1):(header_indices[3] - 1)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "fu3010h0", "dkl010h0"),
                     stringsAsFactors = FALSE)
table2$time <- as.POSIXct(as.character(table2$time), format="%Y%m%d%H")

table3 <- read.table(text = paste(lines[(header_indices[3] + 1):length(lines)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "dkl010d0"),
                     stringsAsFactors = FALSE)
table3$time <- as.POSIXct(as.character(table3$time), format="%Y%m%d")

IDAWEB_final_df <- full_join(IDAWEB_final_df, table1, by = c("stn", "time"))
IDAWEB_final_df <- full_join(IDAWEB_final_df, table2, by = c("stn", "time"))
IDAWEB_final_df <- full_join(IDAWEB_final_df, table3, by = c("stn", "time"))

# Parameter Einheit                              Beschreibung
# fu3010h0  km/h                                 Windgeschwindigkeit skalar; Stundenmittel in km/h
# dkl010h0  °                                    Windrichtung; Stundenmittel
# fkl010z0  m/s                                  Windgeschwindigkeit skalar; Zehnminutenmittel in m/s
# fu3010z0  km/h                                 Windgeschwindigkeit; Zehnminutenmittel in km/h
# dkl010z0  °                                    Windrichtung; Zehnminutenmittel
# dkl010d0  °                                    Windrichtung; Tagesmittel

IDAWEB_final_df <- IDAWEB_final_df |>
  rename(wind_vel_h_kmh = fu3010h0,
         wind_dir_h = dkl010h0,
         wind_vel_10min_ms = fkl010z0,
         wind_vel_10min_kmh = fu3010z0,
         wind_dir_10min = dkl010z0,
         wind_dir_d = dkl010d0)
         
print(IDAWEB_final_df)
```

Large-scale weather situaiton
```{r}
folder <- "../data/IDAWEB/Weather_Type/"
file_path <- list.files(folder, pattern = "data.txt$", full.names = TRUE)
lines <- readLines(file_path)
lines <- lines[lines != ""]
header_indices <- grep("^stn\\s+time", lines)

table1 <- read.table(text = paste(lines[(header_indices[1] + 1):length(lines)], collapse = "\n"), 
                     header = FALSE, col.names = c("stn", "time", "wkcap2d0", "wkcap3d0", "wkcap1d0", "wkwtg1d0", "wkwtp1d0", "wkwtg2d0", "wkwtp2d0", "wkwtg3d0", "wkwtp3d0", "wkwtg0d0"),
                     stringsAsFactors = FALSE) |>
  dplyr::select(-stn) |> # remove station because it is not Thun and can be confusing
  mutate(time = as.POSIXct(as.character(time), format="%Y%m%d")) |>
  #mutate(time = as.POSIXct(as.character(time), format = "%Y-%m-%d %H:%M:%S")) |>
  rowwise() |>
  mutate(time_10min = list(seq(time, time + hours(23) + minutes(50), by = "10 mins"))) |> 
  unnest(time_10min) |>
  select(-time) |>
  rename(time = time_10min)

IDAWEB_final_df <- full_join(IDAWEB_final_df, table1, by = c("time"))

# Parameter Einheit                              Beschreibung
# wkcap2d0    Code                                 CAP/PCACA mit 18 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkcap3d0    Code                                 CAP/PCACA mit 27 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkcap1d0    Code                                 CAP/PCACA mit 9 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkwtg1d0    Code                                 GWT mit 10 Klassen basierend auf 500hPa Geopotential (3E-20E,41N-52N)
# wkwtp1d0    Code                                 GWT mit 10 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkwtg2d0    Code                                 GWT mit 18 Klassen basierend auf 500hPa Geopotential (3E-20E,41N-52N)
# wkwtp2d0    Code                                 GWT mit 18 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkwtg3d0    Code                                 GWT mit 26 Klassen basierend auf 500hPa Geopotential (3E-20E,41N-52N)
# wkwtp3d0    Code                                 GWT mit 26 Klassen basierend auf Bodendruck (3E-20E,41N-52N)
# wkwtg0d0    Code                                 GWT mit 8 Klassen basierend auf 500hPa Geopotential (5E-12E,45N-49N)

IDAWEB_final_df <- IDAWEB_final_df |>
  rename(CAP18 = wkcap2d0,
         CAP27 = wkcap3d0,
         CAP9 = wkcap1d0,
         GWT10_Z500 = wkwtg1d0,
         GWT10_SLP = wkwtp1d0,
         GWT18_Z500 = wkwtg2d0,
         GWT18_SLP = wkwtp2d0,
         GWT26_Z500 = wkwtg3d0,
         GWT26_SLP = wkwtp3d0,
         GWT8_Z500 = wkwtg0d0)

print(IDAWEB_final_df)
```

```{r}
# save the dataframe
write.csv(IDAWEB_final_df, "../data/IDAWEB/MeteoCH_Thun.csv")
```

Classify wind and precipitation
```{r}
MeteoCH_data <- read.csv("../data/IDAWEB/MeteoCH_Thun.csv")
# Convert the time column to a proper datetime format
MeteoCH_data$time <- as.POSIXct(MeteoCH_data$time, format="%Y-%m-%d %H:%M:%S", tz = "UTC")
# Classify wind direction
MeteoCH_data <- MeteoCH_data |>
  mutate(wind_dir_10min_class = case_when(
    wind_dir_10min < 22.5 & wind_dir_10min >= 337.5 ~ "N",
    wind_dir_10min >= 22.5 & wind_dir_10min < 67.5 ~ "NE",
    wind_dir_10min >= 67.5 & wind_dir_10min < 112.5 ~ "E",
    wind_dir_10min >= 112.5 & wind_dir_10min < 157.5 ~ "SE",
    wind_dir_10min >= 157.5 & wind_dir_10min < 202.5 ~ "S",
    wind_dir_10min >= 202.5 & wind_dir_10min < 247.5 ~ "SW",
    wind_dir_10min >= 247.5 & wind_dir_10min < 292.5 ~ "W",
    wind_dir_10min >= 292.5 & wind_dir_10min < 337.5 ~ "NW"
  )) |>
  mutate(wind_dir_h_class = case_when(
    wind_dir_h < 22.5 & wind_dir_h >= 337.5 ~ "N",
    wind_dir_h >= 22.5 & wind_dir_h < 67.5 ~ "NE",
    wind_dir_h >= 67.5 & wind_dir_h < 112.5 ~ "E",
    wind_dir_h >= 112.5 & wind_dir_h < 157.5 ~ "SE",
    wind_dir_h >= 157.5 & wind_dir_h < 202.5 ~ "S",
    wind_dir_h >= 202.5 & wind_dir_h < 247.5 ~ "SW",
    wind_dir_h >= 247.5 & wind_dir_h < 292.5 ~ "W",
    wind_dir_h >= 292.5 & wind_dir_h < 337.5 ~ "NW",
  )) |>
  mutate(wind_dir_d_class = case_when(
    wind_dir_d < 22.5 & wind_dir_d >= 337.5 ~ "N",
    wind_dir_d >= 22.5 & wind_dir_d < 67.5 ~ "NE",
    wind_dir_d >= 67.5 & wind_dir_d < 112.5 ~ "E",
    wind_dir_d >= 112.5 & wind_dir_d < 157.5 ~ "SE",
    wind_dir_d >= 157.5 & wind_dir_d < 202.5 ~ "S",
    wind_dir_d >= 202.5 & wind_dir_d < 247.5 ~ "SW",
    wind_dir_d >= 247.5 & wind_dir_d < 292.5 ~ "W",
    wind_dir_d >= 292.5 & wind_dir_d < 337.5 ~ "NW",
  )) |>
  mutate(wind_dir_10min_NS = ifelse(wind_dir_10min > 90 & wind_dir_10min <= 270, "S", "N"),
         wind_dir_h_NS = ifelse(wind_dir_h > 90 & wind_dir_h <= 270, "S", "N"),
         wind_dir_d_NS = ifelse(wind_dir_d > 90 & wind_dir_d <= 270, "S", "N"))

write.csv(MeteoCH_data, "../data/IDAWEB/MeteoCH_Thun.csv")

```

# Combine Meteo and Low Cost Sensor data
```{r}
MeteoCH_data <- read.csv("../data/IDAWEB/MeteoCH_Thun.csv") |>
  mutate(time = as.POSIXct(MeteoCH_data$time, format="%d.%m.%Y %H:%M", tz = "UTC")) |> 
  mutate(time = with_tz(time, tzone = "Europe/Zurich")) |> #should start at 2024-05-01 02:00
  select(-X.1, -X, -stn)

MeteoCH_data_10min <- MeteoCH_data |>
  select(time, temp_air_2m_10min, temp_pot_2m_10m, precip_10min, RH_2m_10min, glob_rad_10min, airpress_10min, wind_vel_10min_ms, wind_vel_10min_kmh, wind_dir_10min, wind_dir_10min_class, wind_dir_10min_NS, CAP9, CAP18, CAP27, GWT8_Z500, GWT10_SLP, GWT10_Z500, GWT18_SLP, GWT18_Z500, GWT26_SLP, GWT26_Z500) |>
  drop_na()
# TODO: calculate precip last h, 24, h etc.

MeteoCH_data_hourly <- MeteoCH_data |>
  select(time, temp_air_2m_h, precip_last1h, precip_last24h, precip_last72h, RH_2m_h, glob_rad_h, airpress_h, wind_vel_h_kmh, wind_dir_h, wind_dir_h_class, wind_dir_h_NS, CAP9, CAP18, CAP27, GWT8_Z500, GWT10_SLP, GWT10_Z500, GWT18_SLP, GWT18_Z500, GWT26_SLP, GWT26_Z500) |>
  drop_na()

Thun_Network_data <- read.csv("../data/Thun Messnetz 2024/10min_long_2024-05-01_2024-10-30.csv") |>
  mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M:%OS", tz="UTC"),
         timeshift = as.POSIXct(timeshift, format = "%Y-%m-%dT%H:%M:%OS", tz="UTC")) |>
  mutate(time = with_tz(time, tzone = "Europe/Zurich"),
         timeshift = with_tz(timeshift, tzone = "Europe/Zurich")) #should start at 2024-05-01 02:00

Thun_Network_data_hourly <- read.csv("../data/Thun Messnetz 2024/Thun_hourly_summary_2024-05-01_2024-10-30.csv") |>
  mutate(time_hour = as.POSIXct(time_hour, format = "%Y-%m-%dT%H:%M:%OS", tz="UTC")) |>
  mutate(time_hour = with_tz(time_hour, tzone = "Europe/Zurich")) |> #should start at 2024-05-01 02:00
  rename(time = time_hour)

Thun_Network_data_daily <- read.csv("../data/Thun Messnetz 2024/Thun_daily_summary_2024-05-01_2024-10-30.csv") |>
  mutate(time_day = as.POSIXct(time_day, format = "%Y-%m-%dT%H:%M:%OS", tz="UTC")) |>
  mutate(time_day = with_tz(time_day, tzone = "Europe/Zurich")) |> #should start at 2024-05-01 02:00
  rename(time = time_day)
  
meta <- read.csv("../data/Metadata/metadata_Thun.csv") |>
  mutate(Log_NR = paste0("Log_", Log_NR)) |>
  dplyr::select(Log_NR, STANDORT, NORD_CHTOPO, OST_CHTOPO, LV_03_N, LV_03_E, HuM) |>
  distinct(Log_NR, .keep_all = TRUE)
land_use <- read.csv("../data/Metadata/Land_Use_Thun.csv")
```

```{r}
# Combine the two dataframes: 10 minute data
all_data_10min <- full_join(MeteoCH_data_10min, Thun_Network_data, by = "time")

# add metadata
all_data_10min <- all_data_10min |>
  left_join(meta, by = c("Log_NR" = "Log_NR")) |>
  left_join(land_use, by = c("Log_NR" = "Log_NR"))

# hourly data
all_data_hourly <- full_join(MeteoCH_data_hourly, Thun_Network_data_hourly, by = "time")
# add metadata
all_data_hourly <- all_data_hourly |>
  left_join(meta, by = c("Log_NR" = "Log_NR")) |>
  left_join(land_use, by = c("Log_NR" = "Log_NR"))
```



# Burger Model
Calculate Wind variables.
First, we look at some wind roses.
```{r}
# Wind direction
MeteoCH_data_wind <- all_data_10min |>
  select(time, wind_dir_10min, wind_vel_10min_ms, wind_dir_10min_class, wind_dir_10min_NS, UHI, LU_7.type) |>
  drop_na()

ggwindrose(
  speed = MeteoCH_data_wind$wind_vel_10min_ms,
  direction = MeteoCH_data_wind$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

# Nighttime wind
MeteoCH_data_wind_night <- MeteoCH_data_wind |>
  filter(hour(time) >= 22 | hour(time) <= 6)

ggwindrose(
  speed = MeteoCH_data_wind_night$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_night$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose NIGHT (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

# Daytime wind
MeteoCH_data_wind_day <- MeteoCH_data_wind |>
  filter(hour(time) >= 6 & hour(time) <= 22)
ggwindrose(
  speed = MeteoCH_data_wind_day$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_day$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  #speed_cuts = c(1, 2, 3, 5, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose DAY (6am-10pm)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)


```

Plot windroses for different UHIs
```{r}
# filter for land use
MeteoCH_data_wind_UHI <- MeteoCH_data_wind |>
  filter(LU_7.type == "dense urban" | LU_7.type == "green urban" | LU_7.type == "rural") |>
  group_by(time) |>
  summarise(wind_dir_10min = mean(wind_dir_10min, na.rm = TRUE),
            wind_vel_10min_ms = mean(wind_vel_10min_ms, na.rm = TRUE),
            wind_dir_10min_NS = first(wind_dir_10min_NS),
            UHI = mean(UHI, na.rm = TRUE),
            LU_7.type = first(LU_7.type))

# Plot distribution of UHI
ggplot(MeteoCH_data_wind_UHI, aes(x = UHI)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of UHI",
       x = "UHI",
       y = "Frequency") +
  theme_minimal()

MeteoCH_data_wind_UHI_1 <- MeteoCH_data_wind_UHI |>
  filter(UHI > 1)

# plot the windrose
ggwindrose(
  speed = MeteoCH_data_wind_UHI_1$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_UHI_1$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose UHI > 1",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

MeteoCH_data_wind_UHI_neg <- MeteoCH_data_wind_UHI |>
  filter(UHI < 0)

# plot the windrose
ggwindrose(
  speed = MeteoCH_data_wind_UHI_neg$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_UHI_neg$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose UHI < 0",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

# plot windroses only for nighttime
MeteoCH_data_wind_UHI_1_night <- MeteoCH_data_wind_UHI_1 |>
  filter(hour(time) >= 22 | hour(time) <= 6)
ggwindrose(
  speed = MeteoCH_data_wind_UHI_1_night$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_UHI_1_night$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose nightly UHI > 1 (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

MeteoCH_data_wind_UHI_neg_night <- MeteoCH_data_wind_UHI_neg |>
  filter(hour(time) >= 22 | hour(time) <= 6)
ggwindrose(
  speed = MeteoCH_data_wind_UHI_neg_night$wind_vel_10min_ms,
  direction = MeteoCH_data_wind_UHI_neg_night$wind_dir_10min,
  speed_cuts = c(1, 2, 4, 8, 12),
  legend_title = "Wind speed (m/s)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose nightly UHI < 0 (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

```


# Correlate wind speed and direction with UHI
```{r}
# Correlate wind speed and direction with UHI
# symbol of the points should be according to wind_dir_10min_NS
ggplot(MeteoCH_data_wind_UHI, aes(x = wind_vel_10min_ms, y = UHI, color = wind_dir_10min_NS)) +
  geom_point(alpha = 0.4) +  # semi-transparent points
  geom_smooth(method = "lm", se = FALSE) +  # regression lines per group
  labs(
    title = "Correlation between Wind Speed and UHI",
    x = "Wind Speed (m/s)",
    y = "UHI"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("N" = "blue", "S" = "red"))


```

Do the whole thing again with hourly data
```{r}
# Wind direction
MeteoCH_data_wind <- all_data_hourly |>
  select(time, wind_dir_h, wind_vel_h_kmh, wind_dir_h_class, wind_dir_h_NS, UHI_mean, LU_7.type) |>
  drop_na()

ggwindrose(
  speed = MeteoCH_data_wind$wind_vel_h_kmh,
  direction = MeteoCH_data_wind$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

# Nighttime wind
MeteoCH_data_wind_night <- MeteoCH_data_wind |>
  filter(hour(time) >= 22 | hour(time) <= 6)

ggwindrose(
  speed = MeteoCH_data_wind_night$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_night$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose NIGHT (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)

# Daytime wind
MeteoCH_data_wind_day <- MeteoCH_data_wind |>
  filter(hour(time) >= 6 & hour(time) <= 22)
ggwindrose(
  speed = MeteoCH_data_wind_day$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_day$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose DAY (6am-10pm)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)


```


```{r}
# filter for land use
MeteoCH_data_wind_UHI <- MeteoCH_data_wind |>
  filter(LU_7.type == "dense urban" | LU_7.type == "green urban" | LU_7.type == "rural") |>
  group_by(time) |>
  summarise(wind_dir_h = mean(wind_dir_h, na.rm = TRUE),
            wind_vel_h_kmh = mean(wind_vel_h_kmh, na.rm = TRUE),
            wind_dir_h_NS = first(wind_dir_h_NS),
            UHI = mean(UHI_mean, na.rm = TRUE),
            LU_7.type = first(LU_7.type))

MeteoCH_data_wind_UHI_1 <- MeteoCH_data_wind_UHI |>
  filter(UHI > 1)

# plot the windrose
ggwindrose(
  speed = MeteoCH_data_wind_UHI_1$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_1$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose UHI > 1",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIover1.png", width = 6, height = 5, dpi = 300)

MeteoCH_data_wind_UHI_neg <- MeteoCH_data_wind_UHI |>
  filter(UHI < 0)

# plot the windrose
ggwindrose(
  speed = MeteoCH_data_wind_UHI_neg$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_neg$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose UHI < 0",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIneg.png", width = 6, height = 5, dpi = 300)

MeteoCH_data_wind_UHI_low <- MeteoCH_data_wind_UHI |>
  filter(UHI > -0.3 & UHI < 0.3)

# plot the windrose
ggwindrose(
  speed = MeteoCH_data_wind_UHI_low$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_low$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose low UHI (-0.3 < UHI < 0.3) ",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIlow.png", width = 6, height = 5, dpi = 300)

# plot windroses only for nighttime
MeteoCH_data_wind_UHI_1_night <- MeteoCH_data_wind_UHI_1 |>
  filter(hour(time) >= 22 | hour(time) <= 6)
ggwindrose(
  speed = MeteoCH_data_wind_UHI_1_night$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_1_night$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20, 40),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose nightly UHI > 1 (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIover1_night.png", width = 6, height = 5, dpi = 300)

MeteoCH_data_wind_UHI_neg_night <- MeteoCH_data_wind_UHI_neg |>
  filter(hour(time) >= 22 | hour(time) <= 6)
ggwindrose(
  speed = MeteoCH_data_wind_UHI_neg_night$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_neg_night$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20, 40),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose nightly UHI < 0 (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIneg_night.png", width = 6, height = 5, dpi = 300)

# low UHI during night
MeteoCH_data_wind_UHI_low_night <- MeteoCH_data_wind_UHI_low |>
  filter(hour(time) >= 22 | hour(time) <= 6)

ggwindrose(
  speed = MeteoCH_data_wind_UHI_low_night$wind_vel_h_kmh,
  direction = MeteoCH_data_wind_UHI_low_night$wind_dir_h,
  speed_cuts = c(2, 5, 10, 20, 40),
  legend_title = "Wind speed (km/h)",
  calm_wind = 0,
  n_col = 1,
  plot_title = "Thun Wind Rose nightly low UHI (-0.3 < UHI < 0.3) (22pm-6am)",
) + labs(
  subtitle = "May-Oct 2024",
  caption = "Source: MeteoSwiss"
)
ggsave("../figures/Windroses/Wind_Rose_UHIlow_night.png", width = 6, height = 5, dpi = 300)

```

```{r}
# Correlate wind speed and direction with UHI
# symbol of the points should be according to wind_dir_10min_NS
ggplot(MeteoCH_data_wind_UHI, aes(x = wind_vel_h_kmh, y = UHI, color = wind_dir_h_NS)) +
  geom_point(alpha = 0.4) +  # semi-transparent points
  geom_smooth(method = "lm", se = FALSE) +  # regression lines per group
  labs(
    title = "Correlation between Wind Speed and UHI",
    x = "Wind Speed (km/h)",
    y = "UHI"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("N" = "purple", "S" = "darkcyan"))

# If we cut all above 10 km/h windspeed, the regression is different:
MeteoCH_data_wind_UHI |>
  filter(hour(time) >= 22 | hour(time) <= 6) |>
ggplot( aes(x = wind_vel_h_kmh, y = UHI, color = wind_dir_h_NS)) +
  geom_point(alpha = 0.4) +  # semi-transparent points
  geom_smooth(method = "lm", se = FALSE) +  # regression lines per group
  labs(
    title = "Correlation between Wind Speed and nighttime UHI",
    x = "Wind Speed (km/h)",
    y = "UHI"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("N" = "purple", "S" = "darkcyan"))

MeteoCH_data_wind_UHI |>
  filter(wind_vel_h_kmh < 10) |>
  filter(hour(time) >= 22 | hour(time) <= 6) |>
  ggplot(aes(x = wind_vel_h_kmh, y = UHI, color = wind_dir_h_NS)) +
  geom_point(alpha = 0.4) +  # semi-transparent points
  geom_smooth(method = "lm", se = FALSE) +  # regression lines per group
  labs(
    title = "Correlation between Wind Speed and nighttime UHI",
    x = "Wind Speed (km/h)",
    y = "UHI"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("N" = "purple", "S" = "darkcyan"))

MeteoCH_data_wind_UHI |> # seems like the hours are not really decisive
  filter(wind_vel_h_kmh < 10) |>
  filter(hour(time) >= 22 | hour(time) <= 6) |>
  ggplot(aes(x = wind_vel_h_kmh, y = UHI, color = as.factor(hour(time)))) +
  geom_point(alpha = 0.4) +  # semi-transparent points
  geom_smooth(method = "lm", se = FALSE) +  # regression lines per group
  labs(
    title = "Correlation between Wind Speed and nighttime UHI",
    x = "Wind Speed (km/h)",
    y = "UHI"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("22" = "yellow", "23" = "orange", "0" = "red", "1" = "purple", "2" = "blue", "3" = "green", "4" = "cyan", "5" = "magenta", "6" = "black"))
```

Calculate boolean nighttime rain
```{r}

```





Extract values for each station from geospatial layers
```{r}
  tiff_names <- list.files("../data/Geodata/")
  tiff_paths <- paste0("../data/Geodata/",tiff_names)
  tiffs <- terra::rast(tiff_paths)

  spat_points <- metdatada |> dplyr::select(c(LV_03_E,LV_03_N))
  extracted <- terra::extract(tiffs,spat_points)
  combined <- inner_join(combined,extracted,by = "ID")
  combined <- combined |>
    dplyr::select(-ID)

```




