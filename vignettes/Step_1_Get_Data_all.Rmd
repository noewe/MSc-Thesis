---
title: "Maps"
authors: 'No√©mie Wellinger & Nils Tinner'
date: "`r Sys.Date()`"
output: html_document
---

This Rmd script serves to download the measurement data (temperature) from the grafana server.

```{r libraries, include = F}
library(influxdbclient)
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyverse)
```

# Data from current loggers

The time range of the data that should be downloaded can be set manually in the function Logger_data(). By default, this function saves directly the downloaded data directly into a csv. Set the parameter write_csv = F, if you don't want that. The function also interpolates missing data by a maximum of two timesteps before and after the last recorded data. Set interpolate = F Metadata tables that contain the station name, grafana codes, coordinates and installation data of each logger (also replaced loggers) are used to get the data from all loggers that were running in the chosen time frame. The function sorts the data into two big tables (temperature and relative humidity) with rounded 10 minute timesteps and a separate column for each logger.

## Bern

```{r currentloggers, indlude = F}
source("https://raw.github.com/Urban-Climate-Unibe/data_download/main/vignettes/Step_1_Get_Data_all.Rmd")

data <- Logger_data("Bern", date_start = "2024-01-01", interpolate = 0, write_csv = T)
```

## Thun

```{r currentloggers, indlude = F}
source("https://raw.github.com/Urban-Climate-Unibe/Logger_Network/main/R/Logger_Data.R")

data <- Logger_data("thun", date_start = "2024-05-01", date_end = "2024-08-12", interpolate = 0, write_csv = T)
# Somehow it doesn't work when using "Thun" (uppercase) as an argument. 
```

```{r}
# Get the timezone from data$time (should be UTC)
attr(data$time, "tzone")
```

# Plot missing data

```{r plots, include = T}
visdat::vis_miss(
  data,
  cluster = FALSE, 
  warn_large_data = FALSE,
  sort_miss = TRUE # Comment out to sort according to Log_NR
  )

data_cleaned <- data |>
  dplyr::select(-time)
visdat::vis_value(data_cleaned)
```

# Map missing data

```{r}
#########################
# Enter city name
# to display correct map:
city <- "Thun"
#########################

if(city == "Thun"){
  metadata <- read.csv("../Data/metadata_Thun.CSV") |> 
  mutate(Log_NR = paste0("Log_", Log_NR))
}

if(city =="Bern"){
  metadata <- read_csv("https://raw.githubusercontent.com/Urban-Climate-Unibe/Logger_Network/main/data/metadata_gen_2.csv", show_col_types = FALSE) |>
  mutate(Log_NR = paste0("Log_", Log_NR))}


data_missing <- data_cleaned |>
  #summarize by counting how many rows contain NA and dividing by number of rows
  summarize_all(~sum(is.na(.))/n()) |>
  # Add column names as row
  rbind(colnames(data_cleaned)) |>
  t() |>
  as.data.frame() |>
  rename(missing = V1,
         Log_NR = V2) |>
  mutate(missing = as.numeric(missing) * 100)

metadata <- metadata |>
  left_join(data_missing, by = c("Log_NR"))

pal <- leaflet::colorNumeric("plasma", domain = metadata$missing)

leaflet::leaflet(metadata) |>
  leaflet::addTiles() |>
  leaflet::addCircleMarkers(~OST_CHTOPO, ~NORD_CHTOPO, 
                            fillColor = ~pal(missing), radius = 6, fillOpacity = 1, 
                            color = "black", weight = 1, opacity = 1, 
                            popup = paste(
                             "<strong>Measurement type: </strong>", round(metadata$missing))) |>
  leaflet::addLegend("bottomright", pal = leaflet::colorNumeric("plasma", domain = metadata$missing), values = metadata$missing, title = "Missing data in %")
```
