---
title: "Variable Selection"
author: 'Noémie Wellinger'
date: "`r Sys.Date()`"
output: html_document
---

```{r}
source("../R/load_packages.R")
load_packages(c("dplyr", "ggplot2", "lubridate", "ggpubr", "lsr"))
```

Correlation between UHI and predictors
```{r setup, include=FALSE}
meteo_all <- readRDS("../data/final_predictors/all_data_daily.rds")

meteo_all_aggr <- meteo_all |>
  filter(daynight == "n") |>
  group_by(time) |>
  summarise(
    UHI = mean(UHI, na.rm = TRUE),
    wind_vel = first(wind_vel),
    wind_vel_1d = first(wind_vel_1d),
    wind_dir = first(wind_dir),
    wind_dir_1d = first(wind_dir_1d),
    wind_dir_class = first(wind_dir_class),
    wind_dir_1d_class = first(wind_dir_1d_class),
    wind_dir_NS = first(wind_dir_NS),
    wind_dir_1d_NS = first(wind_dir_1d_NS),
    wind_S = first(wind_S),
    wind_S_1d = first(wind_S_1d),
    rad = first(rad),
    rad_1d = first(rad_1d),
    humidity = first(humidity),
    humidity_1d = first(humidity_1d),
    pressure = first(pressure),
    pressure_1d = first(pressure_1d),
    air_temp = first(air_temp),
    air_temp_1d = first(air_temp_1d),
    water_temp = first(air_temp),
    water_temp_1d = first(water_temp_1d),
    precip = first(precip),
    precip_1d = first(precip_1d),
    precip_boolean = first(precip_boolean),
    precip_1d_boolean = first(precip_1d_boolean),
    CAP9 = as.factor(first(CAP9)),
    CAP18 = as.factor(first(CAP18)),
    CAP27 = as.factor(first(CAP27)),
    GWT8_Z500 = as.factor(first(GWT8_Z500)),
    GWT10_SLP = as.factor(first(GWT10_SLP)),
    GWT10_Z500 = as.factor(first(GWT10_Z500)),
    GWT18_SLP = as.factor(first(GWT18_SLP)),
    GWT18_Z500 = as.factor(first(GWT18_Z500)),
    GWT26_SLP = as.factor(first(GWT26_SLP)),
    GWT26_Z500 = as.factor(first(GWT26_Z500))
  ) |>
  ungroup()

```

```{r}
# Filter and compute r for each wind direction
cor_df <- meteo_all_aggr |>
  filter(wind_vel < 10) |>
  group_by(wind_dir_NS) |>
  summarise(r = cor(wind_vel, UHI, use = "complete.obs")) |>
  mutate(r_label = paste0("r (", wind_dir_NS, ") = ", round(r, 2))) |>
  pull(r_label)

# Combine into one subtitle string
subtitle_text <- paste(cor_df, collapse = "; ")

# Plot with subtitle
meteo_all_aggr |>
  ggplot(aes(x = wind_vel, y = UHI, color = wind_dir_NS)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Correlation: nighttime UHI and Wind Speed",
    subtitle = subtitle_text,
    x = "Wind Speed (km/h)",
    y = "UHI [K]",
    color = "Wind Direction"
  ) +
  theme_classic() +
  scale_color_manual(values = c("N" = "darkorange", "S" = "darkcyan")) +
  theme(legend.position = "inside", legend.box = "vertical", 
        legend.justification = c(1,1),
        legend.background = element_rect(fill = "white", color = "black"),
        legend.text = element_text(size = 8),
        plot.subtitle = element_text(size = 8))

ggsave("../results/Variable Selection/WindSpeed_vs_UHI_wind_dir.png", width = 5, height = 5.5, dpi = 300)

```


```{r}
# list with all the variables and their names for the plot titles
variables_num <- list(
  list(name = "wind_vel", title = "Wind Speed [km/h]", descr = "Wind Speed (8h)"),
  list(name = "wind_vel_1d", title = "Wind Speed 1d [km/h]", descr = "Wind Speed (24h)"),
  list(name = "wind_S", title = "Southern Wind Component", descr = "South Wind (8h)"),
  list(name = "wind_S_1d", title = "Southern Wind Component 1d", descr = "South Wind (24h)"),
  list(name = "rad", title = "Global Solar Radiation [W/m²]", descr = "Global Radiation (8h)"),
  list(name = "rad_1d", title = "Global Solar Radiation 1d [W/m²]", descr = "Global Radiation (24h)"),
  list(name = "humidity", title = "Relative Humidity [%]", descr = "Relative Humidity (8h)"),
  list(name = "humidity_1d", title = "Relative Humidity 1d [%]", descr = "Relative Humidity (24h)"),
  list(name = "pressure", title = "Air Pressure [hPa]", descr = "Air Pressure (8h)"),
  list(name = "pressure_1d", title = "Air Pressure 1d [hPa]", descr = "Air Pressure (24h)"),
  list(name = "air_temp", title = "Air Temperature [°C]", descr = "Air Temperature (8h)"),
  list(name = "air_temp_1d", title = "Air Temperature 1d [°C]", descr = "Air Temperature (24h)"),
  list(name = "water_temp", title = "Water Temperature [°C]", descr = "Water Temperature (8h)"),
  list(name = "water_temp_1d", title = "Water Temperature 1d [°C]", descr = "Water Temperature (24h)"),
  list(name = "precip", title = "Precipitation [mm]", descr = "Precipitation (8h)"),
  list(name = "precip_1d", title = "Precipitation 1d [mm]", descr = "Precipitation (24h)")
  # list(name = "precip_boolean", title = "Precipitation Occurrence", descr = "Whether precipitation occurred"),
  # list(name = "precip_1d_boolean", title = "Precipitation Occurrence 1d", descr = "Daily precipitation occurrence")
)

variables_fact <- list(
  list(name = "wind_dir", title = "Wind Direction [°]", descr = "Instantaneous wind direction"),
  list(name = "wind_dir_1d", title = "Wind Direction 1d [°]", descr = "Daily average wind direction"),
  list(name = "wind_dir_class", title = "Wind Direction Class", descr = "Wind direction class (categorical)"),
  list(name = "wind_dir_1d_class", title = "Wind Direction 1d Class", descr = "Daily wind direction class"),
  list(name = "wind_dir_NS", title = "North-South Wind Component", descr = "Instantaneous N–S wind component"),
  list(name = "wind_dir_1d_NS", title = "North-South Wind Component 1d", descr = "Daily N–S wind component"),
  list(name = "CAP9", title = "Circulation Type CAP9", descr = "Circulation type class (9 types)"),
  list(name = "CAP18", title = "Circulation Type CAP18", descr = "Circulation type class (18 types)"),
  list(name = "CAP27", title = "Circulation Type CAP27", descr = "Circulation type class (27 types)"),
  list(name = "GWT8_Z500", title = "GWT8 Z500", descr = "Großwettertyp (8 types) from Z500 field"),
  list(name = "GWT10_SLP", title = "GWT10 SLP", descr = "Großwettertyp (10 types) from SLP field"),
  list(name = "GWT10_Z500", title = "GWT10 Z500", descr = "Großwettertyp (10 types) from Z500 field"),
  list(name = "GWT18_SLP", title = "GWT18 SLP", descr = "Großwettertyp (18 types) from SLP field"),
  list(name = "GWT18_Z500", title = "GWT18 Z500", descr = "Großwettertyp (18 types) from Z500 field"),
  list(name = "GWT26_SLP", title = "GWT26 SLP", descr = "Großwettertyp (26 types) from SLP field"),
  list(name = "GWT26_Z500", title = "GWT26 Z500", descr = "Großwettertyp (26 types) from Z500 field")
)


# Loop through each variable and create a scatter plot

for (var in variables_num) {
  var_name <- var$name
  var_title <- var$title
  var_descr <- var$descr

  # Calculate Pearson correlation coefficient
  r_val <- cor(meteo_all_aggr[[var_name]], meteo_all_aggr$UHI, use = "complete.obs")
  r_text <- paste0("r = ", round(r_val, 2))

  p <- ggplot(meteo_all_aggr, aes(x = !!sym(var_name), y = UHI)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
    labs(
      title = paste("Correlation: nighttime UHI and", var_descr),
      subtitle = r_text,
      x = var_title,
      y = "UHI [K]"
    ) +
    theme_classic() +
    theme(legend.position = "none")
  
  print(p)
  ggsave(paste0("../results/Variable Selection/", var_name, "_vs_UHI.png"), plot = p, 
         width = 5, height = 5.5, dpi = 300)
}
```
Correlation tests for categorical variables like weather type
```{r}
variables_fact <- list(
  list(name = "wind_dir_class", title = "Wind Direction Class", descr = "Wind direction class (categorical)"),
  list(name = "wind_dir_1d_class", title = "Wind Direction 1d Class", descr = "Daily wind direction class"),
  list(name = "wind_dir_NS", title = "North-South Wind Component", descr = "Instantaneous N–S wind component"),
  list(name = "wind_dir_1d_NS", title = "North-South Wind Component 1d", descr = "Daily N–S wind component"),
  list(name = "CAP9", title = "Circulation Type CAP9", descr = "Circulation type class (9 types)"),
  list(name = "CAP18", title = "Circulation Type CAP18", descr = "Circulation type class (18 types)"),
  list(name = "CAP27", title = "Circulation Type CAP27", descr = "Circulation type class (27 types)"),
  list(name = "GWT8_Z500", title = "GWT8 Z500", descr = "Großwettertyp (8 types) from Z500 field"),
  list(name = "GWT10_SLP", title = "GWT10 SLP", descr = "Großwettertyp (10 types) from SLP field"),
  list(name = "GWT10_Z500", title = "GWT10 Z500", descr = "Großwettertyp (10 types) from Z500 field"),
  list(name = "GWT18_SLP", title = "GWT18 SLP", descr = "Großwettertyp (18 types) from SLP field"),
  list(name = "GWT18_Z500", title = "GWT18 Z500", descr = "Großwettertyp (18 types) from Z500 field"),
  list(name = "GWT26_SLP", title = "GWT26 SLP", descr = "Großwettertyp (26 types) from SLP field"),
  list(name = "GWT26_Z500", title = "GWT26 Z500", descr = "Großwettertyp (26 types) from Z500 field")
)

for(var in variables_fact) {
  var_name <- var$name
  var_title <- var$title
  
  # One-way ANOVA
  formula_str <- paste("UHI ~", var_name)
  anova_result <- aov(as.formula(formula_str), data = meteo_all)
  summary(anova_result)
  eta2 <- etaSquared(anova_result)
  
  # Count and dynamic y position for label
  counts <- meteo_all |>
    group_by(!!sym(var_name)) |>
    summarise(
      n = n(),
      max_y = max(UHI, na.rm = TRUE),
      .groups = "drop"
    ) |>
    mutate(label_y = max_y + 0.15)  # small buffer above max
  
  # Plot
  p <- ggplot(meteo_all, aes(x = !!sym(var_name), y = UHI)) +
    geom_boxplot(fill = "skyblue", alpha = 0.7, outlier.colour = "skyblue") +
    geom_text(
      data = counts,
      aes(x = !!sym(var_name), y = label_y, label = paste0("n = ", n)),
      inherit.aes = FALSE,
      size = 3.5
    ) +
    labs(
      title = paste("UHI distribution by", var_title),
      subtitle = paste("Eta-squared:", round(eta2[1], 2)),
      x = "Weather Type", y = "UHI [K]"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(p)

  ggsave(paste0("../results/Variable Selection/", var_name, "_vs_UHI.png"), plot = p,
         width = 7, height = 5.5, dpi = 300)
    rm(p, eta2, anova_result, counts)
}

```

```{r}
# Categorize precipitation into bins
meteo_all_aggr <- meteo_all_aggr |>
  mutate(precip_cat = cut(
    precip,
    breaks = c(-Inf, 0.3, 5, 10, Inf),
    labels = c("≤ 0.3", "0.3–5", "5–10", "> 10"),
    right = FALSE
  ))

# Get counts and max UHI per group
counts <- meteo_all_aggr |>
  group_by(precip_cat) |>
  summarise(
    n = n(),
    max_y = max(UHI, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(label_y = max_y + 0.15)

# ANOVA
anova_result <- aov(UHI ~ precip_cat, data = meteo_all_aggr)
eta2 <- etaSquared(anova_result)

# Plot
ggplot(meteo_all_aggr, aes(x = precip_cat, y = UHI)) +
  geom_boxplot() +
  geom_text(
    data = counts,
    aes(x = precip_cat, y = label_y, label = paste0("n = ", n)),
    inherit.aes = FALSE,
    size = 3.5
  ) +
  labs(
    title = "UHI distribution by Precipitation Category",
    subtitle = paste("Eta-squared:", round(eta2[1], 2)),
    x = "Precipitation [mm]",
    y = "UHI [K]"
  ) +
  theme_classic()

ggsave("../results/Variable Selection/precip_cat_vs_UHI.png", 
       width = 5, height = 5.5, dpi = 300)
```


# Variable selection

We are going to test different algorithms to select the best variables for our model. 
- Boruta
- Random forest stepwise backwards regression
- Correlation matrix

```{r}
meteo_all <- meteo_all |>
  filter(!is.na(UHI))
predictors <- meteo_all |>
  select(
    -time, -Log_NR, -NORD_CHTOPO, -OST_CHTOPO, -LV_03_E, -LV_03_N, -Location,
    -daynight, -air_temp_LCD, -UHI_LCD, -UHI, -LCZ, -LCZ_mixed, -LU_3, -LU_7
  ) |>
  # remove all variables that have "_5d" in their name
  select(-contains("_5d")) |>
  # for variable names that start with "BH_NA", replace NA values with 0
  mutate(across(starts_with("BH_NA"), ~ replace_na(., 0)))
  
```


## Boruta
```{r}
# run the algorithm
bor2 <- Boruta::Boruta(
    y = meteo_all$UHI, 
    x = predictors,
    maxRuns = 30, # Number of iterations. Set to 30 or lower if it takes too long
    num.threads = parallel::detectCores()-1)

# obtain results: a data frame with all variables, ordered by their importance
df_bor2 <- Boruta::attStats(bor) |> 
  tibble::rownames_to_column() |> 
  dplyr::arrange(dplyr::desc(meanImp))

write_csv(df_bor2, "../results/Variable Selection/Boruta_results_2.csv")

# plot the importance result  
ggplot2::ggplot(ggplot2::aes(x = reorder(rowname, meanImp), 
                             y = meanImp,
                             fill = decision), 
                data = df_bor2) +
  ggplot2::geom_bar(stat = "identity", width = 0.75) + 
  ggplot2::scale_fill_manual(values = c("grey30", "tomato", "grey70")) + 
  ggplot2::labs(
    y = "Variable importance", 
    x = "",
    title = "Variable importance based on Boruta") +
  ggplot2::theme_classic() +
  ggplot2::coord_flip()
ggsave("../results/Variable Selection/Boruta_2.png", width = 6, height = 20, dpi = 300)

#start: 13:47
```
