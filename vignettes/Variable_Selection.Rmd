---
title: "Variable Selection"
author: 'Noémie Wellinger'
date: "`r Sys.Date()`"
output: html_document
---

```{r}
source("../R/load_packages.R")
load_packages(c("dplyr", "ggplot2", "lubridate", "ggpubr", "lsr"))
```

Correlation between UHI and predictors
```{r setup, include=FALSE}
meteo_all <- read.csv("../data/final_predictors/predictors_daily_night.csv", 
                       fileEncoding = "latin1"  # Handles ä, ö, ü, ß etc.
                       ) |>
  mutate(time = as.POSIXct(time, format="%Y-%m-%d", tz = "UTC")) |>
  mutate(time = with_tz(time, tzone = "Europe/Zurich")) |> #should start at 2024-05-01 02:00
  # categorical variables as factors
  mutate(
    wd_class = as.factor(wd_class),
    wd_NS = as.factor(wd_NS),
    Wind_S = as.factor(Wind_S),
    CAP9 = as.factor(CAP9),
    CAP18 = as.factor(CAP18),
    CAP27 = as.factor(CAP27),
    GWT8_Z500 = as.factor(GWT8_Z500),
    GWT10_SLP = as.factor(GWT10_SLP),
    GWT10_Z500 = as.factor(GWT10_Z500),
    GWT18_SLP = as.factor(GWT18_SLP),
    GWT18_Z500 = as.factor(GWT18_Z500),
    GWT26_SLP = as.factor(GWT26_SLP),
    GWT26_Z500 = as.factor(GWT26_Z500)
  )

meteo_all_aggr <- meteo_all |>
  group_by(time) |>
  summarise(
    UHI_night = mean(UHI_night, na.rm = TRUE),
    ws = mean(ws),
    wd = mean(wd),
    wd_class = as.factor(first(wd_class)),
    wd_NS = as.factor(first(wd_NS)),
    Wind_S = first(Wind_S),
    glob_rad = first(glob_rad),
    RH_2m = first(RH_2m),
    airpress = first(airpress),
    temp_air_2m = first(temp_air_2m),
    water_temp = first(water_temp),
    precip = first(precip),
    precip_boolean = as.factor(first(precip_boolean)),
    CAP9 = as.factor(first(CAP9)),
    CAP18 = as.factor(first(CAP18)),
    CAP27 = as.factor(first(CAP27)),
    GWT8_Z500 = as.factor(first(GWT8_Z500)),
    GWT10_SLP = as.factor(first(GWT10_SLP)),
    GWT10_Z500 = as.factor(first(GWT10_Z500)),
    GWT18_SLP = as.factor(first(GWT18_SLP)),
    GWT18_Z500 = as.factor(first(GWT18_Z500)),
    GWT26_SLP = as.factor(first(GWT26_SLP)),
    GWT26_Z500 = as.factor(first(GWT26_Z500))
  ) |>
  ungroup()

```

```{r}
# Filter and compute r for each wind direction
cor_df <- meteo_all_aggr |>
  filter(ws < 10) |>
  group_by(wd_NS) |>
  summarise(r = cor(ws, UHI_night, use = "complete.obs")) |>
  mutate(r_label = paste0("r (", wd_NS, ") = ", round(r, 2))) |>
  pull(r_label)

# Combine into one subtitle string
subtitle_text <- paste(cor_df, collapse = "; ")

# Plot with subtitle
meteo_all_aggr |>
  ggplot(aes(x = ws, y = UHI_night, color = wd_NS)) +
  geom_point(alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Correlation: nighttime UHI and Wind Speed",
    subtitle = subtitle_text,
    x = "Wind Speed (km/h)",
    y = "UHI [K]",
    color = "Wind Direction"
  ) +
  theme_classic() +
  scale_color_manual(values = c("N" = "darkorange", "S" = "darkcyan")) +
  theme(legend.position = "inside", legend.box = "vertical", 
        legend.justification = c(1,1),
        legend.background = element_rect(fill = "white", color = "black"),
        legend.text = element_text(size = 8),
        plot.subtitle = element_text(size = 8))

ggsave("../figures/Variable Selection/WindSpeed_vs_UHI_wd.png", width = 5, height = 5.5, dpi = 300)

```


```{r}
# list with all the variables and their names for the plot titles
variables <- list(
  list(name = "temp_air_2m", title = "Air Temperature [°C]", descr = "Air temperature"),
  list(name = "precip", title = "Precipitation [mm]", descr = "Precipitation"),
  list(name = "ws", title = "Wind Speed [km/h]", descr = "Wind speed"),
  list(name = "glob_rad", title = "Global Solar Radiation last 24h [W/m2]", descr = "Global solar radiation"),
  list(name = "RH_2m", title = "Relative Humidity [%]", descr = "Relative humidity"),
  list(name = "airpress", title = "Air Pressure [hPa]", descr = "Air pressure"),
  list(name = "water_temp", title = "Water Temperature [°C]", descr = "Water temperature")
)

# Loop through each variable and create a scatter plot

for (var in variables) {
  var_name <- var$name
  var_title <- var$title
  var_descr <- var$descr

  # Calculate Pearson correlation coefficient
  r_val <- cor(meteo_all_aggr[[var_name]], meteo_all_aggr$UHI_night, use = "complete.obs")
  r_text <- paste0("r = ", round(r_val, 2))

  p <- ggplot(meteo_all_aggr, aes(x = !!sym(var_name), y = UHI_night)) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
    labs(
      title = paste("Correlation: nighttime UHI and", var_descr),
      subtitle = r_text,
      x = var_title,
      y = "UHI [K]"
    ) +
    theme_classic() +
    theme(legend.position = "none")
  
  print(p)
  ggsave(paste0("../figures/Variable Selection/", var_name, "_vs_UHI.png"), plot = p, 
         width = 5, height = 5.5, dpi = 300)
}
```
Correlation tests for categorical variables like weather type
```{r}
variables <- list(
  list(name = "CAP9", title = "CAP9"),
  list(name = "CAP18", title = "CAP18"),
  list(name = "CAP27", title = "CAP27"),
  list(name = "GWT8_Z500", title = "GWT8 Z500"),
  list(name = "GWT10_SLP", title = "GWT10 SLP"),
  list(name = "GWT10_Z500", title = "GWT10 Z500"),
  list(name = "GWT18_SLP", title = "GWT18 SLP"),
  list(name = "GWT18_Z500", title = "GWT18 Z500"),
  list(name = "GWT26_SLP", title = "GWT26 SLP"),
  list(name = "GWT26_Z500", title = "GWT26 Z500")
)

for(var in variables) {
  var_name <- var$name
  var_title <- var$title
  
  # One-way ANOVA
  formula_str <- paste("UHI_night ~", var_name)
  anova_result <- aov(as.formula(formula_str), data = meteo_all)
  summary(anova_result)
  eta2 <- etaSquared(anova_result)
  
  # Count and dynamic y position for label
  counts <- meteo_all |>
    group_by(!!sym(var_name)) |>
    summarise(
      n = n(),
      max_y = max(UHI_night, na.rm = TRUE),
      .groups = "drop"
    ) |>
    mutate(label_y = max_y + 0.15)  # small buffer above max
  
  # Plot
  p <- ggplot(meteo_all, aes(x = !!sym(var_name), y = UHI_night)) +
    geom_boxplot(fill = "skyblue", alpha = 0.7) +
    geom_text(
      data = counts,
      aes(x = !!sym(var_name), y = label_y, label = paste0("n = ", n)),
      inherit.aes = FALSE,
      size = 3.5
    ) +
    labs(
      title = paste("UHI distribution by", var_title),
      subtitle = paste("Eta-squared:", round(eta2[1], 2)),
      x = "Weather Type", y = "UHI [K]"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(p)

  ggsave(paste0("../figures/Variable Selection/", var_name, "_vs_UHI_all_Log.png"), plot = p,
         width = 7, height = 5.5, dpi = 300)
    rm(p, eta2, anova_result, counts)

}

```

```{r}
# Categorize precipitation into bins
meteo_all_aggr <- meteo_all_aggr |>
  mutate(precip_cat = cut(
    precip,
    breaks = c(-Inf, 0.3, 5, 10, Inf),
    labels = c("≤ 0.3", "0.3–5", "5–10", "> 10"),
    right = FALSE
  ))

# Get counts and max UHI per group
counts <- meteo_all_aggr |>
  group_by(precip_cat) |>
  summarise(
    n = n(),
    max_y = max(UHI_night, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(label_y = max_y + 0.15)

# ANOVA
anova_result <- aov(UHI_night ~ precip_cat, data = meteo_all_aggr)
eta2 <- etaSquared(anova_result)

# Plot
ggplot(meteo_all_aggr, aes(x = precip_cat, y = UHI_night)) +
  geom_boxplot() +
  geom_text(
    data = counts,
    aes(x = precip_cat, y = label_y, label = paste0("n = ", n)),
    inherit.aes = FALSE,
    size = 3.5
  ) +
  labs(
    title = "UHI distribution by Precipitation Category",
    subtitle = paste("Eta-squared:", round(eta2[1], 2)),
    x = "Precipitation [mm]",
    y = "UHI [K]"
  ) +
  theme_classic()

ggsave("../figures/Variable Selection/precip_cat_vs_UHI.png", plot = p, 
       width = 5, height = 5.5, dpi = 300)
```


# Variable selection

We are going to test different algorithms to select the best variables for our model. 
- Boruta
- Random forest stepwise backwards regression
- Correlation matrix

```{r}
meteo_all <- meteo_all |>
  filter(!is.na(UHI_night))
predictors <- meteo_all |>
  select(
    -X, -time, -Log_NR, -UHI_night, -NORD_CHTOPO, -OST_CHTOPO, -LV_03_E, -LV_03_N
  )
```


## Boruta
```{r}
 
# run the algorithm
bor <- Boruta::Boruta(
    y = meteo_all$UHI_night, 
    x = predictors,
    maxRuns = 30, # Number of iterations. Set to 30 or lower if it takes too long
    num.threads = parallel::detectCores()-1)

# obtain results: a data frame with all variables, ordered by their importance
df_bor <- Boruta::attStats(bor) |> 
  tibble::rownames_to_column() |> 
  dplyr::arrange(dplyr::desc(meanImp))

# plot the importance result  
ggplot2::ggplot(ggplot2::aes(x = reorder(rowname, meanImp), 
                             y = meanImp,
                             fill = decision), 
                data = df_bor) +
  ggplot2::geom_bar(stat = "identity", width = 0.75) + 
  ggplot2::scale_fill_manual(values = c("grey30", "tomato", "grey70")) + 
  ggplot2::labs(
    y = "Variable importance", 
    x = "",
    title = "Variable importance based on Boruta") +
  ggplot2::theme_classic() +
  ggplot2::coord_flip()
ggsave("../figures/Variable Selection/Boruta.png", width = 6, height = 14, dpi = 300)
```
